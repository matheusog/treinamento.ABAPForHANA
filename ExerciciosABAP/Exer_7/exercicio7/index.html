<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Matheus Goulart">
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Exercício 7 - ABAP For HANA</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">ABAP For HANA</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li >
                                <a href="../../../PreRequisitos/preRequisitos/">Pré-Requisitos</a>
                            </li>
                            <li >
                                <a href="../../../FlightDataModel/flightModel/">Modelo de Dados</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Eclipse <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../ExerciciosEclipse/Exer_1/exercicio1/">Exercício 1</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosEclipse/Exer_2/exercicio2/">Exercício 2</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">HANA <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_1/exercicio1/">Exercício 1</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_2/exercicio2/">Exercício 2</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_3/exercicio3/">Exercício 3</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_4/exercicio4/">Exercício 4</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_5/exercicio5/">Exercício 5</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_6/exercicio6/">Exercício 6</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_7/exercicio7/">Exercício 7</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_8/exercicio8/">Exercício 8</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_9/exercicio9/">Exercício 9</a>
</li>
                                    
<li >
    <a href="../../../ExerciciosHANA/Exer_10/exercicio10/">Exercício 10</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">ABAP <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../Exer_1/exercicio1/">Pacote</a>
</li>
                                    
<li >
    <a href="../../Exer_1_B/exercicio1_b/">Exercício 1</a>
</li>
                                    
<li >
    <a href="../../Exer_2/exercicio2/">Exercício 2</a>
</li>
                                    
<li >
    <a href="../../Exer_3/exercicio3/">Exercício 3</a>
</li>
                                    
<li >
    <a href="../../Exer_4/exercicio4/">Exercício 4</a>
</li>
                                    
<li >
    <a href="../../Exer_5/exercicio5/">Exercício 5</a>
</li>
                                    
<li >
    <a href="../../Exer_6/exercicio6/">Exercício 6</a>
</li>
                                    
<li class="active">
    <a href="./">Exercício 7</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../../Exer_6/exercicio6/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="disabled">
                                <a rel="prev" >
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/matheusog/treinamento.ABAPForHANA.git/edit/master/docs/ExerciciosABAP/Exer_7/exercicio7.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#exercicio-7-abap">Exercício 7 - ABAP</a></li>
            <li><a href="#contexto">Contexto</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="exercicio-7-abap">Exercício 7 - ABAP</h1>
<p>&nbsp;</p>
<h2 id="contexto">Contexto</h2>
<p>&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_01" class="center" src="../../img/Exer_7/EXER7_01.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_02" class="center" src="../../img/Exer_7/EXER7_02.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_03" class="center" src="../../img/Exer_7/EXER7_03.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_04" class="center" src="../../img/Exer_7/EXER7_04.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_05" class="center" src="../../img/Exer_7/EXER7_05.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_06" class="center" src="../../img/Exer_7/EXER7_06.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_07" class="center" src="../../img/Exer_7/EXER7_07.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_08" class="center" src="../../img/Exer_7/EXER7_08.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_09" class="center" src="../../img/Exer_7/EXER7_09.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_10" class="center" src="../../img/Exer_7/EXER7_10.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_11" class="center" src="../../img/Exer_7/EXER7_11.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_12" class="center" src="../../img/Exer_7/EXER7_12.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_13" class="center" src="../../img/Exer_7/EXER7_13.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_14" class="center" src="../../img/Exer_7/EXER7_14.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_15" class="center" src="../../img/Exer_7/EXER7_15.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_16" class="center" src="../../img/Exer_7/EXER7_16.jpg" />
&nbsp;</p>
<p>&nbsp;
<img alt="EXER7_17" class="center" src="../../img/Exer_7/EXER7_17.jpg" />
&nbsp;</p>
<pre><code>class ZCL_AMDP_EXER_7_GOULARTM definition
  public.

public section.

    interfaces:
        if_amdp_marker_hdb.

    class-methods
        get_data_exer_7
            for table function ZDDL_TBF_EXER7_GOULARTM.

protected section.
private section.
ENDCLASS.



CLASS ZCL_AMDP_EXER_7_GOULARTM IMPLEMENTATION.
  method get_data_exer_7
    by database function
    for hdb
    language sqlscript
    options read-only
    using
        spfli
        scarr
        sairport.

 lt_connections =
    select
        MANDT       ,
        CARRID      ,
        CONNID      ,
        COUNTRYFR   ,
        CITYFROM    ,
        AIRPFROM    ,
        DEPTIME     ,
        FLTIME      ,
        COUNTRYTO   ,
        CITYTO      ,
        AIRPTO      ,
        ARRTIME
            from spfli
            where MANDT = :p_mandt
            ;

 lt_airports =
    select
        MANDT           ,
        ID  as AIRPID   ,
        NAME
            from sairport
            where MANDT = :p_mandt
              and ID    in ( select distinct AIRPFROM from :lt_connections
                                union distinct
                             select distinct AIRPTO from :lt_connections )
            ;

 lt_companies =
    select
        MANDT       ,
        CARRID      ,
        CARRNAME    ,
        CURRCODE
            from scarr
            where MANDT     = :p_mandt
              and CARRID    in ( select distinct CARRID from :lt_connections )
            ;


 lt_connections_join =
    select
        connection.MANDT        as CLIENT                   ,
        connection.CARRID       as AIRCOMPANY_ID            ,
        company.CARRNAME        as COMPANY_NAME             ,
        company.CURRCODE        as COMPANY_CURRENCY         ,
        connection.CONNID       as CONNECTION_ID            ,
        connection.COUNTRYFR    as DEPARTURE_COUNTRY        ,
        connection.CITYFROM     as DEPARTURE_CITY           ,
        connection.AIRPFROM     as DEPARTURE_AIRPORT        ,
        airport_from.NAME       as DEPARTURE_AIRPORT_NAME   ,
        connection.DEPTIME      as DEPARTURE_TIME           ,
        connection.FLTIME       as FLIGHT_TIME              ,
        connection.COUNTRYTO    as ARRIVE_COUNTRY           ,
        connection.CITYTO       as ARRIVE_CITY              ,
        connection.AIRPTO       as ARRIVE_AIRPORT           ,
        airport_to.NAME         as ARRIVE_AIRPORT_NAME      ,
        connection.ARRTIME      as ARRIVE_TIME              ,
        concat( connection.COUNTRYFR, concat( '/',
            concat( connection.CITYFROM, concat( ' - ',
                concat( airport_from.NAME, concat( ' - ',
                    TO_NVARCHAR( to_time( connection.DEPTIME ) , 'HH:mm:SS' ) )
        ) ) ) ) )               as DEPARTURE_TEXT

            FROM :lt_connections as connection

                inner join :lt_companies as company
                    on  company.MANDT   = connection.MANDT
                    and company.CARRID  = connection.CARRID

                inner join :lt_airports as airport_from
                    on  airport_from.MANDT  = connection.MANDT
                    and airport_from.AIRPID = connection.AIRPFROM

                inner join :lt_airports as airport_to
                    on  airport_to.MANDT    = connection.MANDT
                    and airport_to.AIRPID   = connection.AIRPTO
                ;

    lt_connections_join = apply_filter( :lt_connections_join, :p_filter );

     return
        select * from :lt_connections_join ;



  endmethod.
ENDCLASS.
</code></pre>

<pre><code>define table function ZDDL_TBF_EXER7_GOULARTM
with parameters @Environment.systemField: #CLIENT
                  p_mandt:abap.clnt,
                  p_filter: abap.sstring( 300 )
returns {
          CLIENT                  : abap.clnt;
          AIRCOMPANY_ID           : s_carr_id ;
          COMPANY_NAME            : s_carrname;
          COMPANY_CURRENCY        : s_currcode;
          CONNECTION_ID           : s_conn_id;
          DEPARTURE_COUNTRY       : land1;
          DEPARTURE_CITY          : s_from_cit;
          DEPARTURE_AIRPORT       : s_fromairp;
          DEPARTURE_AIRPORT_NAME  : s_airpname;
          DEPARTURE_TIME          : s_dep_time;
          FLIGHT_TIME             : s_fltime;
          ARRIVE_COUNTRY          : land1;
          ARRIVE_CITY             : s_to_city;
          ARRIVE_AIRPORT          : s_toairp;
          ARRIVE_AIRPORT_NAME     : s_airpname;
          ARRIVE_TIME             : s_arr_time; 
          DEPARTURE_TEXT          : abap.sstring( 100 );

}
implemented by method ZCL_AMDP_EXER_7_GOULARTM=&gt;get_data_exer_7;
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
